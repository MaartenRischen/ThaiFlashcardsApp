<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thai Flashcard Generation Logic - Implementation Details</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            line-height: 1.6;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            color: #333;
        }
        .section {
            margin-bottom: 40px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .implementation-note {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 10px;
            margin: 10px 0;
        }
        .code {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            font-family: monospace;
            white-space: pre;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f8f9fa;
        }
        .warning {
            color: #856404;
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>Thai Flashcard Generation Logic - Implementation Details</h1>

    <div class="section">
        <h2>1. Model Selection & Fallback System</h2>
        <div class="implementation-note">
            ⚠️ Note: This section reflects the actual implementation with dynamic batch sizing and sophisticated retry mechanisms.
        </div>
        
        <h3>Model Priority Chain</h3>
        <div class="code">
const TEXT_MODELS = [
    'google/gemini-2.5-flash-preview',    // Primary choice
    'google/gemini-2.5-pro-preview-03-25', // First fallback
    'openai/gpt-4',                       // Second fallback
    'openai/gpt-3.5-turbo',               // Third fallback
    'anthropic/claude-3-opus',            // Fourth fallback
    'mistralai/mixtral-8x7b'             // Final fallback
];
        </div>

        <h3>Dynamic Batch Processing</h3>
        <div class="code">
// Dynamic batch size based on model capabilities
function getBatchSize(model: string): number {
    switch (model) {
        case 'google/gemini-2.5-flash-preview': return 8;
        case 'openai/gpt-4': return 4;
        default: return 3;
    }
}

// Exponential backoff retry strategy
const MAX_RETRIES = 3;
const getBackoffDelay = (retry: number) => Math.pow(2, retry) * 1000;
        </div>

        <h3>Error Handling System</h3>
    <table>
            <tr>
                <th>Error Type</th>
                <th>Handling Strategy</th>
                <th>Retry Logic</th>
            </tr>
            <tr>
                <td>API Errors</td>
                <td>Model fallback + exponential backoff</td>
                <td>Up to 3 retries per model</td>
            </tr>
            <tr>
                <td>Network Errors</td>
                <td>Immediate retry with backoff</td>
                <td>Up to 3 retries</td>
            </tr>
            <tr>
                <td>Validation Errors</td>
                <td>Partial result acceptance + continue</td>
                <td>No retry (non-retryable)</td>
            </tr>
            <tr>
                <td>Parse Errors</td>
                <td>Model fallback</td>
                <td>Switch model, then retry</td>
            </tr>
        </table>
    </div>

    <div class="section">
        <h2>2. Temperature Control System</h2>
        <div class="implementation-note">
            ⚠️ Note: Temperature control is tightly integrated with tone levels and affects both generation and validation.
        </div>

        <h3>Temperature Mapping</h3>
        <div class="code">
// Non-linear temperature progression based on tone level
function getTemperatureFromToneLevel(toneLevel: number | undefined): number {
    // Default to level 5 (balanced) if undefined
    const level = toneLevel ?? 5;
    
    // Clamp between 1 and 10
    const clampedLevel = Math.max(1, Math.min(10, level));
    
    const temperatureMap: Record<number, number> = {
        1: 0.1,   // Dead serious
        2: 0.3,   // Barely a smile
        3: 0.4,   // Slight humor
        4: 0.5,   // Last practical level
        5: 0.7,   // Starting to get weird
        6: 0.8,   // Definitely weird
        7: 0.9,   // Very weird
        8: 0.95,  // Reality-bending
        9: 1.5,   // Reality-breaking
        10: 2.0   // Maximum possible chaos
    };
    
    return temperatureMap[clampedLevel];
}
        </div>

        <h3>Temperature Behavior by Level</h3>
        <table>
            <tr>
                <th>Level</th>
                <th>Temperature</th>
                <th>Generation Behavior</th>
                <th>Validation Rules</th>
            </tr>
            <tr><td>1</td><td>0.1</td><td>Dead serious, purely practical, textbook-style</td><td>Strict practicality and grammar</td></tr>
            <tr><td>2</td><td>0.3</td><td>Serious, very subtle levity allowed</td><td>Strict practicality and grammar</td></tr>
            <tr><td>3</td><td>0.4</td><td>Practical, emerging fun/humor</td><td>Practicality, grammar</td></tr>
            <tr><td>4</td><td>0.5</td><td>Playful practicality, noticeable humor</td><td>Practicality, grammar</td></tr>
            <tr><td>5</td><td>0.7</td><td>Balanced absurdity, mix of practical and illogical</td><td>Grammar, relaxed semantic validation</td></tr>
            <tr><td>6</td><td>0.8</td><td>Leaning weird, bizarre contexts</td><td>Grammar, relaxed semantic validation</td></tr>
            <tr><td>7</td><td>0.9</td><td>Very weird, surreal humor, strange concepts</td><td>Grammar, relaxed semantic validation</td></tr>
            <tr><td>8</td><td>0.95</td><td>Reality-bending, semantically strange</td><td>Grammar only</td></tr>
            <tr><td>9</td><td>1.5</td><td>Reality-breaking, chaotic, nonsensical</td><td>Grammar only</td></tr>
            <tr><td>10</td><td>2.0</td><td>Maximum chaos, pure surrealism</td><td>Grammar only</td></tr>
    </table>
    </div>

    <div class="section">
        <h2>3. Batch Processing System</h2>
        <div class="implementation-note">
            ⚠️ Note: Batch processing includes sophisticated progress tracking and error aggregation.
        </div>

        <h3>Batch Generation Flow</h3>
        <div class="code">
interface BatchProgress {
    completed: number;
    total: number;
    latestPhrases?: Phrase[];
}

// Main generation loop with progress tracking
for (let i = 0; i < batchesNeeded; i++) {
    // Update progress immediately
    onProgressUpdate?.({ 
        completed: allPhrases.length, 
        total: totalCount,
        latestPhrases: allPhrases.slice(-3)
    });
    
    // Calculate remaining phrases needed
    const remaining = totalCount - allPhrases.length;
    const countForBatch = Math.min(remaining, batchSize);
    
    // Generate batch with retries
    let retries = 0;
    while (retries < MAX_RETRIES) {
        try {
            const result = await generateOpenRouterBatch(
                prompt, 
                TEXT_MODELS,
                i,
                preferences.toneLevel
            );
            
            if (result.phrases.length > 0) break;
            
            retries++;
            await new Promise(resolve => 
                setTimeout(resolve, getBackoffDelay(retries))
            );
        } catch (error) {
            aggregatedErrors.push(createBatchError(error, i));
            retries++;
        }
    }
}
        </div>

        <h3>Error Aggregation</h3>
        <div class="code">
interface BatchError {
    type: 'PARSE' | 'VALIDATION' | 'API' | 'NETWORK' | 'UNKNOWN';
    message: string;
    details?: unknown;
    batchIndex: number;
}

interface ErrorSummary {
    errorTypes: string[];
    totalErrors: number;
    userMessage: string;
}
        </div>
    </div>

    <div class="section">
        <h2>4. Storage Pipeline</h2>
        <div class="implementation-note">
            ⚠️ Note: This outlines the flow for saving generated sets and their associated data.
        </div>

        <h3>Set Data Mapping</h3>
        <div class="code">
// Data saved to Supabase 'sets' table
interface SetData {
    id: string; // Unique identifier (e.g., cuid)
    userId: string; // Clerk User ID
    name: string; // User-provided or derived name
    description?: string; // Optional description
    imageUrl?: string; // Supabase Storage URL for cover image
    phrases: Phrase[]; // Array of generated phrases
    sourcePreferences: Preferences; // User preferences used for generation
    createdAt: timestamp;
    updatedAt: timestamp;
}
        </div>

        <h3>Transaction Sequence</h3>
        <ol>
            <li>Generate phrases using the logic described in previous sections.</li>
            <li>If image generation is requested (and successful):
                <ul>
                    <li>Receive image data (e.g., base64 or buffer) from image generation service (e.g., Ideogram).</li>
                    <li>Upload image to Supabase Storage bucket (e.g., 'set-images') under a unique path (e.g., `set-images/{setId}/{setId}_{timestamp}.webp`).</li>
                    <li>Get the public URL for the uploaded image from Supabase Storage.</li>
                </ul>
            </li>
            <li>Construct the `SetData` object, including the `imageUrl` if applicable.</li>
            <li>Insert the `SetData` object into the Supabase `sets` table.</li>
            <li>Handle potential errors during image upload or database insertion.</li>
        </ol>
    </div>

    <div class="section">
        <h2>5. Frontend Image Handling (Supabase Optimization)</h2>
        <div class="implementation-note">
            ⚠️ Note: This describes how set cover images stored in Supabase are optimized for frontend display.
        </div>
        <p>
            To ensure fast loading times for set cover images (which might be large when initially generated and stored in Supabase), a custom Next.js Image Loader (`supabase-image-loader.js`) is used in conjunction with the `<Image>` component.
        </p>
        <h3>Process:</h3>
        <ol>
            <li>The Next.js `<Image>` component is used wherever a set cover image needs to be displayed (e.g., in the "My Sets" modal).</li>
            <li>The `src` prop passed to `<Image>` is the full public Supabase Storage URL (e.g., `https://<project_id>.supabase.co/storage/v1/object/public/set-images/.../image.webp`).</li>
            <li>The `next.config.js` file is configured to use the custom `supabase-image-loader.js`.</li>
            <li>The custom loader (`supabase-image-loader.js`):
                <ul>
                    <li>Intercepts the `src` provided to the `<Image>` component.</li>
                    <li><strong>Checks if the `src` starts with `/`. If yes, it returns the `src` unchanged (passes through local images).</strong></li>
                    <li>If the `src` is identified as a Supabase URL:
                        <ul>
                            <li>Extracts the bucket path (e.g., `set-images/.../image.webp`) from the full URL.</li>
                            <li>Constructs a new Supabase Image Transformation URL using the project ID and the extracted path.</li>
                            <li>Appends `width` and `quality` parameters to the transformation URL based on the props passed to the `<Image>` component (or defaults).</li>
                        </ul>
                    </li>
                    <li>Returns the final transformation URL to the `<Image>` component.</li>
                </ul>
            </li>
            <li>Supabase then serves a dynamically resized and optimized (e.g., WebP) version of the image based on the transformation URL parameters.</li>
            <li>Local images (like logos, UI elements stored in `/public/images/`) are handled by the default Next.js loader and are not processed by the Supabase loader.</li>
        </ol>
        <h3>Benefits:</h3>
        <ul>
            <li>Reduced bandwidth usage.</li>
            <li>Faster image loading times for users, especially for potentially large generated set covers.</li>
            <li>Automatic optimization (like format conversion to WebP) handled by Supabase.</li>
        </ul>
        <div class="code">
// Relevant configuration in next.config.js
images: {
    loader: 'custom',
    loaderFile: './supabase-image-loader.js',
    // ... other configs like remotePatterns
},

// Simplified logic within supabase-image-loader.js
export default function supabaseLoader({ src, width, quality }) {
    // 1. Check if src starts with '/' -> return src (local image)
    // 2. Check if src is Supabase URL 
    // 3. Extract path from URL
    // 4. Construct transformation URL: https://<projectId>.supabase.co/storage/v1/render/image/public/<path>?width=...&quality=...
    // 5. Return transformation URL
}
        </div>
    </div>

    <div class="section">
        <h2>6. Proficiency Level Definitions (Generation Prompt)</h2>
        <div class="implementation-note">
            ⚠️ Note: These rules are directly incorporated into the `buildGenerationPrompt` function to guide the LLM.
        </div>
        <table>
            <thead>
                <tr>
                    <th>Proficiency Level</th>
                    <th>Description & Constraints</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Complete Beginner</td>
                    <td>Use ONLY single words or two-word combinations (noun+verb or noun+adjective). Focus on the absolute most basic, high-frequency vocabulary. Examples must be single-word or two-word statements only. NO questions, NO dialogues, NO complex structures.</td>
                </tr>
                <tr>
                    <td>Basic Understanding</td>
                    <td>Use short, practical phrases (2-4 words). Focus on basic S-V-O structures and common expressions for everyday needs. Simple questions are okay. Avoid dialogues. Examples should be basic descriptive statements about daily life.</td>
                </tr>
                <tr>
                    <td>Intermediate</td>
                    <td>Use medium-length descriptive sentences (4-7 words). Include basic compound structures and typical vocabulary for common situations. Simple questions and compound sentences are okay. Avoid dialogues. Examples should describe everyday situations.</td>
                </tr>
                <tr>
                    <td>Advanced</td>
                    <td>Use moderately complex sentences (7-12 words). Include varied grammar structures and more nuanced vocabulary. Complex questions and compound-complex sentences are okay. Avoid dialogues. Examples should demonstrate natural Thai expression.</td>
                </tr>
                <tr>
                    <td>Native/Fluent</td>
                    <td>Use natural, idiomatic Thai (any appropriate length). Include slang, cultural references, and educated native speech patterns. Complex questions and varied sentence structures are encouraged. Avoid dialogues. Examples should sound like authentic Thai.</td>
                </tr>
                <tr>
                    <td>God Mode</td>
                    <td>Use sophisticated, elaborate Thai (extended length). Include rare vocabulary, advanced grammar patterns, and literary/academic language. Complex questions and varied structures are encouraged. Avoid dialogues. Examples should demonstrate mastery of formal and literary Thai.</td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="section">
        <h2>7. Prompt Structure (Simplified Template)</h2>
        <div class="implementation-note">
            ⚠️ Note: This is a high-level template. The actual prompt (`buildGenerationPrompt`) is much more detailed.
        </div>
        <div class="code">
## Base Instructions
Generate [COUNT] unique, simple Thai phrases related to "[TOPIC]".
Target audience proficiency: [PROFICIENCY LEVEL].

## Proficiency Constraints ([PROFICIENCY LEVEL])
[DETAILED RULES FOR THE LEVEL - e.g., word count, grammar, vocabulary based on table above]

## Tone and Style
Adopt a [TONE DESCRIPTION - derived from toneLevel] tone. [Specific tone instructions].

## Formatting Rules
Provide output strictly as a JSON array of objects:
[ { "thai": "...", "english": "...", "pronunciation": "...", "context": "...", "example": { "thai_sentence": "...", "english_sentence": "..."} } ]
Ensure JSON is valid. No extra text.

## Existing Phrases (Avoid Duplicates)
[LIST OF PHRASES ALREADY GENERATED/IN SET]
        </div>
    </div>

    <div class="section">
        <h2>8. Validation System</h2>
        <div class="implementation-note">
            ⚠️ Note: Validation steps occur after generation, before phrases are returned/saved. The tone-based semantic check is currently a placeholder.
        </div>
        <h3>Validation Steps:</h3>
        <ol>
            <li><strong>Structure & Content Validation:</strong> Checks if required fields exist (<code>english</code>, <code>thai</code>, etc.), data types are correct, and minimum example count (>=2) is met. Checks basic mnemonic quality. Performed on all tones.</li>
            <li><strong>Duplicate Check:</strong> Normalizes and compares the <code>english</code> phrase against existing phrases in the batch to prevent duplicates. Performed on all tones.</li>
            <li>
                <strong>Semantic Validation (Tone-Dependent):</strong> Checks if the generated content makes logical sense.
                <ul>
                    <li><strong>Tones 1-6 (Strict):</strong> Semantic checks are performed. Illogical or nonsensical phrases/examples should be rejected. (<em>Code currently has placeholder - assumes pass</em>).</li>
                    <li><strong>Tones 7-8 (Partial):</strong> Semantic checks are currently <strong>skipped</strong> (treated as 'none').</li>
                    <li><strong>Tones 9-10 (None):</strong> Semantic checks are skipped, allowing absurd or nonsensical (but grammatically correct) content.</li>
                </ul>
            </li>
        </ol>
        <h3>Semantic Check Logic (Based on Tone):</h3>
        <ul>
            <li><strong>Tone Level 1-6 (Conservative/Creative):</strong> Require strict semantic relevance checks. <em>(Currently implemented as a placeholder `// TODO` that assumes pass).</em></li>
            <li><strong>Tone Level 7-10 (Chaotic):</strong> Skip strict semantic checks (weirdness is expected/allowed).</li>
        </ul>
        <div class="warning">
            <strong>Warning:</strong> The "strict semantic check" for lower tone levels is not fully implemented in `generateOpenRouterBatch`. It currently assumes phrases pass this check. This needs to be built out for full validation accuracy.
        </div>
        <div class="code">
// Example of how rules *might* be represented (Conceptual)
 interface ValidationRules {
     // Structure validation
     requiredFields: string[];
     typeChecks: Record<string, string>;
     
     // Content validation
     minExamples: number;
     // maxPhraseLength: Record<string, number>; // Not currently implemented based on tone
     // requireMnemonic: boolean; // Quality checked instead
     
     // Tone-specific rules
     // allowedContexts: string[]; // Handled by semanticChecks
     semanticChecks: 'strict' | 'partial' | 'none'; // Determines if logical sense is checked
     grammarChecks: boolean; // Should always be true
 }
 
 // Conceptual rule sets based on CURRENT IMPLEMENTATION:
 const validationRulesByTone: Record<number, { semanticChecks: 'strict' | 'none' }> = {
     1: { semanticChecks: 'strict' }, // Tones 1-6
     2: { semanticChecks: 'strict' },
     3: { semanticChecks: 'strict' },
     4: { semanticChecks: 'strict' },
     5: { semanticChecks: 'strict' },
     6: { semanticChecks: 'strict' },
     7: { semanticChecks: 'none' },   // Tones 7-10 (incl. 'partial')
     8: { semanticChecks: 'none' },
     9: { semanticChecks: 'none' },
     10: { semanticChecks: 'none' }
 };
        </div>
    </div>

    <div class="section">
        <h2>9. API Route Details (/api/generate-set)</h2>
        <div class="implementation-note">
            ⚠️ Note: This details the server-side handling of generation requests.
        </div>
        <h3>Authentication & Authorization</h3>
        <!-- ... existing content ... -->
        <h3>Request Handling Flow</h3>
        <!-- ... existing list ... -->
        <h3>Response Structure</h3>
        <!-- ... existing code ... -->
    </div>
</body>
</html> 