<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thai Flashcard Generation Logic - Implementation Details</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            line-height: 1.6;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            color: #333;
        }
        .section {
            margin-bottom: 40px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .implementation-note {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 10px;
            margin: 10px 0;
        }
        .code {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            font-family: monospace;
            white-space: pre;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f8f9fa;
        }
        .warning {
            color: #856404;
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>Thai Flashcard Generation Logic - Implementation Details</h1>
    
    <div class="section">
        <h2>1. Model Selection & Fallback System</h2>
        <div class="implementation-note">
            ⚠️ Note: This section reflects the actual implementation with dynamic batch sizing and sophisticated retry mechanisms.
        </div>
        
        <h3>Model Priority Chain</h3>
        <div class="code">
const TEXT_MODELS = [
    'google/gemini-2.5-flash-preview',    // Primary choice
    'google/gemini-2.5-pro-preview-03-25', // First fallback
    'openai/gpt-4',                       // Second fallback
    'openai/gpt-3.5-turbo',               // Third fallback
    'anthropic/claude-3-opus',            // Fourth fallback
    'mistralai/mixtral-8x7b'             // Final fallback
];
        </div>

        <h3>Dynamic Batch Processing</h3>
        <div class="code">
// Dynamic batch size based on model capabilities
function getBatchSize(model: string): number {
    switch (model) {
        case 'google/gemini-2.5-flash-preview': return 8;
        case 'openai/gpt-4': return 4;
        default: return 3;
    }
}

// Exponential backoff retry strategy
const MAX_RETRIES = 3;
const getBackoffDelay = (retry: number) => Math.pow(2, retry) * 1000;
        </div>

        <h3>Error Handling System</h3>
        <table>
            <tr>
                <th>Error Type</th>
                <th>Handling Strategy</th>
                <th>Retry Logic</th>
            </tr>
            <tr>
                <td>API Errors</td>
                <td>Model fallback + exponential backoff</td>
                <td>Up to 3 retries per model</td>
            </tr>
            <tr>
                <td>Network Errors</td>
                <td>Immediate retry with backoff</td>
                <td>Up to 3 retries</td>
            </tr>
            <tr>
                <td>Validation Errors</td>
                <td>Partial result acceptance + continue</td>
                <td>No retry (non-retryable)</td>
            </tr>
            <tr>
                <td>Parse Errors</td>
                <td>Model fallback</td>
                <td>Switch model, then retry</td>
            </tr>
        </table>
    </div>

    <div class="section">
        <h2>2. Temperature Control System</h2>
        <div class="implementation-note">
            ⚠️ Note: Temperature control is tightly integrated with tone levels and affects both generation and validation.
        </div>

        <h3>Temperature Mapping</h3>
        <div class="code">
// Non-linear temperature progression based on tone level
function getTemperatureFromToneLevel(toneLevel: number | undefined): number {
    // Default to level 5 (balanced) if undefined
    const level = toneLevel ?? 5;
    
    // Clamp between 1 and 10
    const clampedLevel = Math.max(1, Math.min(10, level));
    
    const temperatureMap: Record<number, number> = {
        1: 0.1,   // Dead serious
        2: 0.3,   // Barely a smile
        3: 0.4,   // Slight humor
        4: 0.5,   // Last practical level
        5: 0.7,   // Starting to get weird
        6: 0.8,   // Definitely weird
        7: 0.9,   // Very weird
        8: 0.95,  // Reality-bending
        9: 1.5,   // Reality-breaking
        10: 2.0   // Maximum possible chaos
    };
    
    return temperatureMap[clampedLevel];
}
        </div>

        <h3>Temperature Behavior by Level</h3>
        <table>
            <tr>
                <th>Level</th>
                <th>Temperature</th>
                <th>Generation Behavior</th>
                <th>Validation Rules</th>
            </tr>
            <tr><td>1</td><td>0.1</td><td>Dead serious, purely practical, textbook-style</td><td>Strict practicality and grammar</td></tr>
            <tr><td>2</td><td>0.3</td><td>Serious, very subtle levity allowed</td><td>Strict practicality and grammar</td></tr>
            <tr><td>3</td><td>0.4</td><td>Practical, emerging fun/humor</td><td>Practicality, grammar</td></tr>
            <tr><td>4</td><td>0.5</td><td>Playful practicality, noticeable humor</td><td>Practicality, grammar</td></tr>
            <tr><td>5</td><td>0.7</td><td>Balanced absurdity, mix of practical and illogical</td><td>Grammar, relaxed semantic validation</td></tr>
            <tr><td>6</td><td>0.8</td><td>Leaning weird, bizarre contexts</td><td>Grammar, relaxed semantic validation</td></tr>
            <tr><td>7</td><td>0.9</td><td>Very weird, surreal humor, strange concepts</td><td>Grammar, relaxed semantic validation</td></tr>
            <tr><td>8</td><td>0.95</td><td>Reality-bending, semantically strange</td><td>Grammar only</td></tr>
            <tr><td>9</td><td>1.5</td><td>Reality-breaking, chaotic, nonsensical</td><td>Grammar only</td></tr>
            <tr><td>10</td><td>2.0</td><td>Maximum chaos, pure surrealism</td><td>Grammar only</td></tr>
        </table>
    </div>

    <div class="section">
        <h2>3. Batch Processing System</h2>
        <div class="implementation-note">
            ⚠️ Note: Batch processing includes sophisticated progress tracking and error aggregation.
        </div>

        <h3>Batch Generation Flow</h3>
        <div class="code">
interface BatchProgress {
    completed: number;
    total: number;
    latestPhrases?: Phrase[];
}

// Main generation loop with progress tracking
for (let i = 0; i < batchesNeeded; i++) {
    // Update progress immediately
    onProgressUpdate?.({ 
        completed: allPhrases.length, 
        total: totalCount,
        latestPhrases: allPhrases.slice(-3)
    });
    
    // Calculate remaining phrases needed
    const remaining = totalCount - allPhrases.length;
    const countForBatch = Math.min(remaining, batchSize);
    
    // Generate batch with retries
    let retries = 0;
    while (retries < MAX_RETRIES) {
        try {
            const result = await generateOpenRouterBatch(
                prompt, 
                TEXT_MODELS,
                i,
                preferences.toneLevel
            );
            
            if (result.phrases.length > 0) break;
            
            retries++;
            await new Promise(resolve => 
                setTimeout(resolve, getBackoffDelay(retries))
            );
        } catch (error) {
            aggregatedErrors.push(createBatchError(error, i));
            retries++;
        }
    }
}
        </div>

        <h3>Error Aggregation</h3>
        <div class="code">
interface BatchError {
    type: 'PARSE' | 'VALIDATION' | 'API' | 'NETWORK' | 'UNKNOWN';
    message: string;
    details?: unknown;
    batchIndex: number;
}

interface ErrorSummary {
    errorTypes: string[];
    totalErrors: number;
    userMessage: string;
}
        </div>
    </div>

    <div class="section">
        <h2>4. Storage Pipeline</h2>
        <div class="implementation-note">
            ⚠️ Note: Storage includes compatibility mapping and rollback mechanisms.
        </div>

        <h3>Storage Flow</h3>
        <div class="code">
// Metadata mapping for database compatibility
function mapStorageToDatabase(storageSet: SetMetaData): DatabaseSet {
    const { toneLevel, ...rest } = storageSet;
    return {
        ...rest,
        seriousnessLevel: toneLevel, // Backward compatibility
    };
}

function mapDatabaseToStorage(dbSet: DatabaseSet): SetMetaData {
    return {
        ...dbSet,
        toneLevel: dbSet.seriousnessLevel,
    };
}

// Storage sequence with rollback
async function storeGeneratedSet(userId: string, set: CustomSet) {
    const session = await startTransaction();
    try {
        // 1. Save metadata
        const meta = await saveMetadata(session, userId, set);
        
        // 2. Save phrases
        const phrases = await savePhrases(session, meta.id, set.phrases);
        
        // 3. Save progress data
        const progress = await saveProgress(session, meta.id);
        
        await session.commitTransaction();
        return { meta, phrases, progress };
    } catch (error) {
        await session.abortTransaction();
        throw error;
    }
}
        </div>
    </div>

    <div class="section">
        <h2>5. Prompt Structure</h2>
        <div class="implementation-note">
            ⚠️ Note: Prompt includes dynamic components based on tone level and proficiency.
        </div>

        <h3>Core Components</h3>
        <ol>
            <li>Task Context & Requirements
                <ul>
                    <li>AI role definition</li>
                    <li>Critical requirements (Level & Tone)</li>
                    <li>User preferences</li>
                </ul>
            </li>
            <li>Detailed Instructions
                <ul>
                    <li>Set title generation rules</li>
                    <li>Proficiency level implementation</li>
                    <li>Tone level implementation</li>
                    <li>Topic/situation control</li>
                    <li>Duplicate prevention</li>
                </ul>
            </li>
            <li>Output Schema
                <ul>
                    <li>JSON structure definition</li>
                    <li>Interface specifications</li>
                    <li>Validation requirements</li>
                </ul>
            </li>
        </ol>

        <h3>Dynamic Elements</h3>
        <table>
            <tr>
                <th>Component</th>
                <th>Dynamic Factors</th>
                <th>Implementation Notes</th>
            </tr>
            <tr>
                <td>Example Generation</td>
                <td>Tone Level + Proficiency</td>
                <td>Examples match both complexity and absurdity level</td>
            </tr>
            <tr>
                <td>Mnemonic Rules</td>
                <td>Tone Level</td>
                <td>Balance between memorability and tone-appropriate style</td>
            </tr>
            <tr>
                <td>Validation Rules</td>
                <td>Proficiency Level</td>
                <td>Strict enforcement of level-appropriate complexity</td>
            </tr>
        </table>
    </div>

    <div class="section">
        <h2>6. Generation Parameters</h2>
        <div class="implementation-note">
            ⚠️ Note: Parameters are dynamically adjusted based on multiple factors.
        </div>

        <h3>Dynamic Parameters</h3>
        <table>
            <tr>
                <th>Parameter</th>
                <th>Range</th>
                <th>Adjustment Factors</th>
            </tr>
            <tr>
                <td>Batch Size</td>
                <td>3-8</td>
                <td>Model capabilities, memory constraints</td>
            </tr>
            <tr>
                <td>Temperature</td>
                <td>0.1-2.0</td>
                <td>Tone level, model characteristics</td>
            </tr>
            <tr>
                <td>Retry Count</td>
                <td>0-3</td>
                <td>Error type, model availability</td>
            </tr>
            <tr>
                <td>Backoff Delay</td>
                <td>1s-8s</td>
                <td>Retry attempt number</td>
            </tr>
        </table>
    </div>

    <div class="section">
        <h2>7. Validation System</h2>
        <div class="implementation-note">
            ⚠️ Note: Comprehensive validation system with tone-aware rules.
        </div>

        <h3>Validation Rules</h3>
        <div class="code">
interface ValidationRules {
    // Structure validation
    requiredFields: string[];
    typeChecks: Record<string, string>;
    
    // Content validation
    minExamples: number;
    maxPhraseLength: Record<string, number>;
    requireMnemonic: boolean;
    
    // Tone-specific rules
    allowedContexts: string[];
    semanticChecks: boolean;
    grammarChecks: boolean;
}

// Rule sets vary by tone level
const validationRules: Record<number, ValidationRules> = {
    1: { strict: true, semanticChecks: true, ... },
    5: { strict: false, semanticChecks: partial, ... },
    10: { strict: false, semanticChecks: false, ... }
};
        </div>
    </div>

    <div class="section">
        <h2>8. Progress Tracking</h2>
        <div class="implementation-note">
            ⚠️ Note: Sophisticated progress tracking with multiple metrics.
        </div>

        <h3>Progress Interface</h3>
        <div class="code">
interface GenerationProgress {
    completed: number;
    total: number;
    latestPhrases?: Phrase[];
    errors?: BatchError[];
    currentModel?: string;
    batchesCompleted: number;
    estimatedTimeRemaining?: number;
}
        </div>
    </div>

    <div class="section">
        <h2>9. Error Handling</h2>
        <div class="implementation-note">
            ⚠️ Note: Comprehensive error handling with aggregation and recovery.
        </div>

        <h3>Error Types</h3>
        <table>
            <tr>
                <th>Type</th>
                <th>Recovery Strategy</th>
                <th>User Impact</th>
            </tr>
            <tr>
                <td>Model Errors</td>
                <td>Fallback to next model</td>
                <td>Minimal - transparent retry</td>
            </tr>
            <tr>
                <td>Validation Errors</td>
                <td>Partial acceptance</td>
                <td>Reduced set size</td>
            </tr>
            <tr>
                <td>Critical Errors</td>
                <td>Fallback content</td>
                <td>Basic set provided</td>
            </tr>
        </table>
    </div>

    <div class="section">
        <h2>10. UI Integration</h2>
        <div class="implementation-note">
            ⚠️ Note: Complete UI system for tone selection and progress tracking.
        </div>

        <h3>Components</h3>
        <ul>
            <li>Tone Selection
                <ul>
                    <li>Slider interface (1-10)</li>
                    <li>Visual previews</li>
                    <li>Example content</li>
                </ul>
            </li>
            <li>Progress Display
                <ul>
                    <li>Completion percentage</li>
                    <li>Latest phrases</li>
                    <li>Error summaries</li>
                </ul>
            </li>
            <li>Error Handling
                <ul>
                    <li>User-friendly messages</li>
                    <li>Retry options</li>
                    <li>Fallback content</li>
                </ul>
            </li>
        </ul>
    </div>
</body>
</html> 