<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Donkey Bridge - Set Generation Logic & Architecture</title>
    <style>
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
            line-height: 1.6;
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
            color: #333;
            background-color: #f9f9f9;
        }
        h1, h2, h3 { color: #1a1a1a; }
        .section {
            margin-bottom: 40px;
            padding: 25px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background-color: #ffffff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .sub-section {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        .note {
            background-color: #e7f3ff;
            border-left: 4px solid #007bff;
            padding: 12px 15px;
            margin: 15px 0;
            border-radius: 4px;
            font-size: 0.95em;
            color: #004085;
        }
        .warning {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 12px 15px;
            margin: 15px 0;
            border-radius: 4px;
            font-size: 0.95em;
            color: #856404;
        }
        .code {
            background-color: #2d2d2d;
            color: #f1f1f1;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            font-family: "SF Mono", Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            white-space: pre;
            font-size: 0.9em;
            margin: 10px 0;
        }
        .highlight { font-weight: bold; color: #0056b3; }
        .error { color: #dc3545; font-weight: bold; }
        .success { color: #28a745; font-weight: bold; }
        li { margin-bottom: 5px; }
        code { background-color: #eee; padding: 2px 5px; border-radius: 3px; font-family: monospace;}
        .mapping-table th, .mapping-table td { padding: 8px 12px; border: 1px solid #ddd; }
        .mapping-table { border-collapse: collapse; width: 100%; margin: 10px 0; }
        .mapping-table th { background: #f8f9fa; }
        .flow-step { 
            background: #f8f9fa; 
            border: 1px solid #dee2e6; 
            border-radius: 6px; 
            padding: 15px; 
            margin: 10px 0; 
            position: relative;
        }
        .flow-step::before {
            content: "Step " counter(step-counter);
            counter-increment: step-counter;
            position: absolute;
            top: -12px;
            left: 15px;
            background: #007bff;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: bold;
        }
        .flow-container {
            counter-reset: step-counter;
        }
    </style>
</head>
<body>
    <h1>Donkey Bridge: Set Generation Logic & Architecture (2024)</h1>

    <div class="section">
        <h2>1. Overview: Modern SetWizard Architecture</h2>
        <div class="note">
            Donkey Bridge uses a sophisticated 7-step wizard to transform user preferences into personalized Thai flashcard sets. The system features advanced batch processing, multiple LLM fallbacks, and comprehensive error handling.
        </div>
        
        <div class="flow-container">
            <div class="flow-step">
                <strong>SetWizard Flow:</strong> User configures preferences through 7 interactive steps
            </div>
            <div class="flow-step">
                <strong>Generation Module:</strong> Modular batch processing with intelligent prompt construction
            </div>
            <div class="flow-step">
                <strong>LLM Processing:</strong> Multi-model approach with automatic fallbacks
            </div>
            <div class="flow-step">
                <strong>Validation & Enhancement:</strong> Comprehensive phrase validation and gendered variations
            </div>
            <div class="flow-step">
                <strong>Image Generation:</strong> AI-generated set covers using Ideogram v3
            </div>
            <div class="flow-step">
                <strong>Storage & UI:</strong> Database persistence with real-time UI updates
            </div>
        </div>
    </div>

    <div class="section">
        <h2>2. SetWizard: 7-Step User Journey</h2>
        <div class="sub-section">
            <h3>2.1. Step Flow & Components</h3>
            <table class="mapping-table">
                <tr><th>Step</th><th>Component</th><th>Purpose</th><th>Data Collected</th></tr>
                <tr><td>0</td><td>WelcomeStep</td><td>Introduction with animated GIF</td><td>None (entry point)</td></tr>
                <tr><td>1</td><td>ProficiencyStep</td><td>Thai level selection with slider & images</td><td>levelEstimate (Complete Beginner → God Mode)</td></tr>
                <tr><td>2</td><td>ScenarioStep</td><td>Topic selection (custom goal, scenarios, weird)</td><td>selectedTopic {type, value}</td></tr>
                <tr><td>3</td><td>ContextStep</td><td>Additional context refinement</td><td>additionalContext (structured Q&A)</td></tr>
                <tr><td>4</td><td>ToneStep</td><td>Learning style (1-10 scale) with images</td><td>tone (1=serious, 10=absurd)</td></tr>
                <tr><td>5</td><td>ReviewStep</td><td>Summary & card count adjustment</td><td>cardCount (5-30 cards)</td></tr>
                <tr><td>6</td><td>GenerationStep</td><td>Real-time generation with progress</td><td>Triggers API call</td></tr>
            </table>
        </div>
        
        <div class="sub-section">
            <h3>2.2. Modern UI Features</h3>
            <ul>
                <li><b>Image Preloading:</b> All step images preloaded for instant transitions</li>
                <li><b>Responsive Sliders:</b> Custom-styled range inputs with visual feedback</li>
                <li><b>Smart Scenarios:</b> Level-appropriate topic suggestions</li>
                <li><b>Real-time Preview:</b> Live placeholder creation during generation</li>
                <li><b>Smooth Animations:</b> Framer Motion transitions between steps</li>
                <li><b>Progress Indicators:</b> Visual step tracking with active states</li>
            </ul>
        </div>
    </div>

    <div class="section">
        <h2>3. Generation Module Architecture</h2>
        <div class="sub-section">
            <h3>3.1. Modular Structure</h3>
            <div class="code">app/lib/generation/
├── index.ts              # Main exports
├── types.ts              # TypeScript interfaces
├── constants.ts          # Models, batch sizes, linguistic rules
├── prompt-generator.ts   # System & user prompt construction
├── phrase-validator.ts   # Validation & normalization
└── batch-processor.ts    # Batch processing logic</div>
        </div>
        
        <div class="sub-section">
            <h3>3.2. Multi-Model Strategy</h3>
            <div class="code">TEXT_MODELS = [
  'google/gemini-2.5-flash-preview',     // Primary (batch size: 8)
  'google/gemini-2.5-pro-preview-03-25', // Fallback (batch size: 3)
  'openai/gpt-4',                        // Fallback (batch size: 4)
  'openai/gpt-3.5-turbo',               // Fallback (batch size: 3)
  'anthropic/claude-3-opus',            // Fallback (batch size: 3)
  'mistralai/mixtral-8x7b'              // Final fallback (batch size: 3)
]</div>
            <div class="warning">
                The system automatically tries each model in sequence until successful generation or all models are exhausted. Batch sizes are optimized per model capability.
            </div>
        </div>
        
        <div class="sub-section">
            <h3>3.3. Enhanced Phrase Structure</h3>
            <div class="code">interface Phrase {
  english: string;
  thai: string;
  thaiMasculine: string;    // NEW: Gender-specific variations
  thaiFeminine: string;     // NEW: Gender-specific variations  
  pronunciation: string;
  mnemonic?: string;
  examples: ExampleSentence[];
}

interface ExampleSentence {
  thai: string;
  thaiMasculine: string;    // NEW: Gendered examples
  thaiFeminine: string;     // NEW: Gendered examples
  pronunciation: string;
  translation: string;
}</div>
        </div>
    </div>

    <div class="section">
        <h2>4. Advanced Prompt Engineering</h2>
        <div class="sub-section">
            <h3>4.1. System Prompt Features</h3>
            <ul>
                <li><b>Cultural Awareness:</b> Thai hierarchies, communication patterns, face-saving</li>
                <li><b>Gendered Speech:</b> Automatic masculine/feminine variations with appropriate particles</li>
                <li><b>Register Sensitivity:</b> Formal/informal context switching</li>
                <li><b>Authenticity Focus:</b> Natural phrases over literal translations</li>
                <li><b>Politeness Particles:</b> Context-appropriate ครับ/ค่ะ/จ้ะ/นะ usage</li>
                <li><b>Modern Colloquialisms:</b> Current slang and expressions</li>
            </ul>
        </div>
        
        <div class="sub-section">
            <h3>4.2. Level-Specific Adaptations</h3>
            <table class="mapping-table">
                <tr><th>Level</th><th>Complexity</th><th>Focus Areas</th></tr>
                <tr><td>Complete Beginner</td><td>1-4 words</td><td>Essential nouns, basic greetings, simple concrete vocabulary</td></tr>
                <tr><td>Basic Understanding</td><td>4-7 words</td><td>Daily needs, polite particles, simple sentence structures</td></tr>
                <tr><td>Intermediate</td><td>6-12 words</td><td>Everyday situations, common idioms, mixed registers</td></tr>
                <tr><td>Advanced</td><td>8-15 words</td><td>Sophisticated vocabulary, cultural references, advanced grammar</td></tr>
                <tr><td>Native/Fluent</td><td>Natural length</td><td>Full register range, slang, cultural expressions, humor</td></tr>
                <tr><td>God Mode</td><td>Peak complexity</td><td>Rare expressions, classical references, regional dialects</td></tr>
            </table>
        </div>
        
        <div class="sub-section">
            <h3>4.3. Tone Integration</h3>
            <div class="code">function getToneDescription(level: number): string {
  // Maps 1-10 scale to LLM temperature and style instructions
  // 1: "Textbook realism" (temp: 0.1)
  // 5: "A little too much maybe" (temp: 0.5) 
  // 10: "Glitched donkey mode" (temp: 1.0)
}</div>
        </div>
    </div>

    <div class="section">
        <h2>5. Batch Processing & Error Handling</h2>
        <div class="sub-section">
            <h3>5.1. Intelligent Batching</h3>
            <ul>
                <li><b>Dynamic Batch Sizes:</b> Optimized per model (Gemini 2.5: 8, GPT-4: 4, others: 3)</li>
                <li><b>Parallel Processing:</b> Multiple batches processed simultaneously</li>
                <li><b>Staggered Delays:</b> API rate limiting prevention</li>
                <li><b>Deduplication:</b> Cross-batch duplicate detection and removal</li>
                <li><b>Progress Tracking:</b> Real-time UI updates during generation</li>
            </ul>
        </div>
        
        <div class="sub-section">
            <h3>5.2. Comprehensive Validation</h3>
            <div class="code">Validation Pipeline:
1. Structure validation (required fields, types)
2. Gendered variation completeness
3. Example sentence validation (minimum 2 per phrase)
4. Thai script verification
5. Pronunciation format checking
6. Mnemonic creativity assessment
7. Cultural sensitivity review</div>
        </div>
        
        <div class="sub-section">
            <h3>5.3. Error Recovery</h3>
            <ul>
                <li><b>Model Fallbacks:</b> Automatic retry with next available model</li>
                <li><b>Partial Success:</b> Combine successful batches with fallback phrases</li>
                <li><b>Detailed Logging:</b> Error classification and debugging information</li>
                <li><b>User Feedback:</b> Friendly error messages with recovery suggestions</li>
                <li><b>Graceful Degradation:</b> Minimum viable set creation even with failures</li>
            </ul>
        </div>
    </div>

    <div class="section">
        <h2>6. Image Generation Pipeline</h2>
        <div class="sub-section">
            <h3>6.1. Ideogram v3 Integration</h3>
            <ul>
                <li><b>API:</b> Ideogram v3 with TURBO rendering speed</li>
                <li><b>Resolution:</b> 1344x768 (16:9 aspect ratio)</li>
                <li><b>Style:</b> GENERAL style type for versatility</li>
                <li><b>Prompt Engineering:</b> Structured prompts with mandatory elements</li>
                <li><b>Text Prohibition:</b> Comprehensive negative prompts preventing any text</li>
            </ul>
        </div>
        
        <div class="sub-section">
            <h3>6.2. Storage Strategy</h3>
            <div class="code">Image Processing Flow:
1. Generate image via Ideogram v3 API
2. Receive temporary Ideogram URL
3. Upload to Supabase storage for permanence
4. Store Supabase URL in database
5. Fallback: Use original Ideogram URL if upload fails
6. Frontend: Handle null imageUrl with default images</div>
        </div>
        
        <div class="sub-section">
            <h3>6.3. Prompt Structure</h3>
            <div class="code">Image Prompt Template:
"Create a cute cartoon style illustration with these STRICT REQUIREMENTS:
1. MAIN FOCUS: Visual representation of '{topic}' without ANY text
2. MANDATORY ELEMENTS: Friendly donkey AND bridge interacting with topic
3. STYLE: Vibrant, friendly colors and clean cartoon style
4. CRITICAL TEXT PROHIBITION: NO text, letters, numbers, or writing
5. COMPOSITION: Balanced 16:9 landscape composition
6. QUALITY: High detail and clean lines"</div>
        </div>
    </div>

    <div class="section">
        <h2>7. Database & Storage Architecture</h2>
        <div class="sub-section">
            <h3>7.1. Data Models</h3>
            <table class="mapping-table">
                <tr><th>Table</th><th>Purpose</th><th>Key Fields</th></tr>
                <tr><td>FlashcardSet</td><td>Set metadata</td><td>id, name, cleverTitle, level, imageUrl, llmBrand, llmModel, seriousnessLevel</td></tr>
                <tr><td>FlashcardContent</td><td>Phrase data</td><td>setId, english, thai, thaiMasculine, thaiFeminine, pronunciation, mnemonic</td></tr>
                <tr><td>FlashcardExamples</td><td>Example sentences</td><td>contentId, thai, thaiMasculine, thaiFeminine, pronunciation, translation</td></tr>
                <tr><td>UserProgress</td><td>Learning progress</td><td>userId, setId, cardProgress, completionStats</td></tr>
            </table>
        </div>
        
        <div class="sub-section">
            <h3>7.2. Real-time UI Updates</h3>
            <ul>
                <li><b>Placeholder Creation:</b> Immediate UI feedback during generation</li>
                <li><b>Progress Tracking:</b> Live updates via React context</li>
                <li><b>Optimistic Updates:</b> UI updates before database confirmation</li>
                <li><b>Error Recovery:</b> Automatic cleanup of failed generations</li>
                <li><b>Context Synchronization:</b> SetContext manages global state</li>
            </ul>
        </div>
    </div>

    <div class="section">
        <h2>8. API Routes & Integration</h2>
        <div class="sub-section">
            <h3>8.1. Core Endpoints</h3>
            <table class="mapping-table">
                <tr><th>Endpoint</th><th>Purpose</th><th>Key Features</th></tr>
                <tr><td>/api/generate-set</td><td>Main generation endpoint</td><td>Full generation pipeline, authentication, cleanup</td></tr>
                <tr><td>/api/flashcard-sets</td><td>CRUD operations</td><td>Set management, progress tracking</td></tr>
                <tr><td>/api/generate-placeholder-image</td><td>Placeholder generation</td><td>Immediate UI feedback</td></tr>
                <tr><td>/api/test-variations</td><td>Development testing</td><td>Batch testing, model comparison</td></tr>
            </table>
        </div>
        
        <div class="sub-section">
            <h3>8.2. Authentication & Security</h3>
            <ul>
                <li><b>Clerk Integration:</b> User authentication and session management</li>
                <li><b>User Upsert:</b> Automatic user creation in database</li>
                <li><b>Request Validation:</b> Input sanitization and validation</li>
                <li><b>Rate Limiting:</b> API protection and resource management</li>
                <li><b>Error Sanitization:</b> Safe error messages for production</li>
            </ul>
        </div>
    </div>

    <div class="section">
        <h2>9. Performance & Optimization</h2>
        <div class="sub-section">
            <h3>9.1. Frontend Optimizations</h3>
            <ul>
                <li><b>Image Preloading:</b> All wizard images loaded on component mount</li>
                <li><b>Dynamic Imports:</b> Code splitting for wizard components</li>
                <li><b>Memoization:</b> React.memo and useMemo for expensive operations</li>
                <li><b>Debounced Inputs:</b> Reduced API calls during user input</li>
                <li><b>Optimistic Updates:</b> Immediate UI feedback</li>
            </ul>
        </div>
        
        <div class="sub-section">
            <h3>9.2. Backend Optimizations</h3>
            <ul>
                <li><b>Batch Processing:</b> Parallel LLM requests with optimal batch sizes</li>
                <li><b>Connection Pooling:</b> Efficient database connections</li>
                <li><b>Caching:</b> Static content and frequent queries</li>
                <li><b>Streaming:</b> Large response handling</li>
                <li><b>Background Processing:</b> Non-blocking operations</li>
            </ul>
        </div>
    </div>

    <div class="section">
        <h2>10. Monitoring & Debugging</h2>
        <div class="sub-section">
            <h3>10.1. Logging Strategy</h3>
            <div class="code">Log Levels:
- Generation progress and batch completion
- Model fallbacks and retry attempts  
- Validation failures and error classification
- Performance metrics and timing
- User journey tracking through wizard steps
- API response times and error rates</div>
        </div>
        
        <div class="sub-section">
            <h3>10.2. Error Classification</h3>
            <table class="mapping-table">
                <tr><th>Error Type</th><th>Description</th><th>Recovery Strategy</th></tr>
                <tr><td>API_ERROR</td><td>LLM API failures</td><td>Model fallback, retry logic</td></tr>
                <tr><td>INVALID_DATA</td><td>Malformed responses</td><td>Validation, filtering</td></tr>
                <tr><td>RATE_LIMIT</td><td>API rate limiting</td><td>Exponential backoff</td></tr>
                <tr><td>STORAGE_ERROR</td><td>Database/file issues</td><td>Cleanup, retry</td></tr>
                <tr><td>VALIDATION_ERROR</td><td>Input validation</td><td>User feedback</td></tr>
            </table>
        </div>
    </div>

    <div class="section">
        <h2>11. Testing & Development</h2>
        <div class="sub-section">
            <h3>11.1. Test Infrastructure</h3>
            <ul>
                <li><b>Unit Tests:</b> Validation functions, utilities</li>
                <li><b>Integration Tests:</b> API endpoints, database operations</li>
                <li><b>Component Tests:</b> SetWizard step functionality</li>
                <li><b>E2E Tests:</b> Complete user journey testing</li>
                <li><b>Performance Tests:</b> Load testing, batch processing</li>
            </ul>
        </div>
        
        <div class="sub-section">
            <h3>11.2. Development Tools</h3>
            <ul>
                <li><b>Test Variations Page:</b> Batch testing across levels and tones</li>
                <li><b>Debug Endpoints:</b> Environment checking, health monitoring</li>
                <li><b>Logging Dashboard:</b> Real-time error tracking</li>
                <li><b>Performance Profiling:</b> Generation timing analysis</li>
                <li><b>Mock Data:</b> Development and testing fixtures</li>
            </ul>
        </div>
    </div>

</body>
</html> 