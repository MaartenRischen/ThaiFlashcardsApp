<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thai Flashcard Generation Logic - Updated Implementation</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f8f9fa;
            color: #333;
            line-height: 1.6;
        }
        h1, h2, h3 {
            color: #0056b3;
        }
        h1, h2 {
            border-bottom: 2px solid #dee2e6;
            padding-bottom: 0.3em;
            margin-bottom: 1em;
        }
        .section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .code {
            font-family: monospace;
            background: #f5f5f5;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
        }
        .flow-diagram {
            margin: 20px 0;
            padding: 15px;
            background: #fff;
            border-radius: 4px;
        }
        .mermaid {
            background: white;
            padding: 20px;
            border-radius: 8px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        th, td {
            border: 1px solid #dee2e6;
            padding: 12px;
            text-align: left;
        }
        th {
            background: #f8f9fa;
        }
        .highlight {
            background-color: #e8f4ff;
            padding: 2px 4px;
            border-radius: 3px;
        }
        .warning {
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
</head>
<body>
    <h1>Thai Flashcard Generation Logic - Updated Implementation</h1>

    <div class="section">
        <h2>1. Model Selection & Temperature Control</h2>
        <div class="code">
            // Prioritized list of models with fallback system
            const TEXT_MODELS = [
                'google/gemini-2.5-flash-preview',    // Primary choice
                'google/gemini-2.5-pro-preview-03-25', // First fallback
                'openai/gpt-4',                       // Second fallback
                'openai/gpt-3.5-turbo',               // Third fallback
                'anthropic/claude-3-opus',            // Fourth fallback
                'mistralai/mixtral-8x7b'             // Final fallback
            ];

            // Non-linear temperature mapping based on tone level
            const temperatureMap = {
                1: 0.1,   // Dead serious
                2: 0.3,   // Barely a smile
                3: 0.4,   // Slight humor
                4: 0.5,   // Last practical level
                5: 0.7,   // Starting to get weird
                6: 0.8,   // Definitely weird
                7: 0.9,   // Very weird
                8: 0.95,  // Reality-bending
                9: 1.5,   // Reality-breaking
                10: 2.0   // Maximum possible chaos
            };
        </div>
    </div>

    <div class="section">
        <h2>2. Generation Pipeline</h2>
        <div class="mermaid">
        graph TD
            A[Start Generation] --> B[Initialize Progress]
            B --> C[Calculate Batch Parameters]
            C --> D[Begin Batch Processing]
            D --> E{Try Primary Model}
            E -->|Success| F[Process Results]
            E -->|Failure| G{Try Next Model}
            G -->|Success| F
            G -->|All Failed| H[Use Fallback Data]
            F --> I{More Batches?}
            I -->|Yes| D
            I -->|No| J[Finalize Results]
            H --> J
            J --> K[Return Response]

            subgraph "Error Handling"
                L[Network Error]
                M[API Error]
                N[Validation Error]
                O[Parse Error]
                P[Unknown Error]
            end

            subgraph "Retry Logic"
                Q[Exponential Backoff]
                R[Max 3 Retries]
                S[Model Fallback]
            end
        </div>
    </div>

    <div class="section">
        <h2>3. Batch Processing Details</h2>
        <table>
            <tr>
                <th>Component</th>
                <th>Implementation Details</th>
            </tr>
            <tr>
                <td>Batch Size</td>
                <td>
                    - Dynamic sizing based on remaining cards<br>
                    - Maximum of 8 cards per batch<br>
                    - Adjusts for final batch
                </td>
            </tr>
            <tr>
                <td>Progress Tracking</td>
                <td>
                    - Real-time updates<br>
                    - Tracks completed/total cards<br>
                    - Includes latest phrases<br>
                    - Percentage calculation
                </td>
            </tr>
            <tr>
                <td>Error Handling</td>
                <td>
                    - Type-specific error handling<br>
                    - Error aggregation<br>
                    - Detailed error summaries<br>
                    - Fallback mechanisms
                </td>
            </tr>
            <tr>
                <td>Validation</td>
                <td>
                    - JSON structure validation<br>
                    - Phrase structure validation<br>
                    - Example sentence validation<br>
                    - Mnemonic validation
                </td>
            </tr>
        </table>
    </div>

    <div class="section">
        <h2>4. Storage Pipeline</h2>
        <div class="mermaid">
        graph TD
            A[Generation Complete] --> B[Prepare Metadata]
            B --> C[Save Metadata]
            C --> D{Image Generation}
            D -->|Success| E[Save Image URL]
            D -->|Failure| F[Use Default Image]
            E --> G[Save Phrases]
            F --> G
            G --> H[Save Progress]
            H --> I[Return Complete Set]

            subgraph "Metadata Processing"
                J[Process Tone Level]
                K[Map Proficiency Level]
                L[Handle Title Generation]
            end

            subgraph "Cleanup Handlers"
                M[Error Cleanup]
                N[Partial Data Cleanup]
                O[Image Cleanup]
            end
        </div>
    </div>

    <div class="section">
        <h2>5. Tone Level Integration</h2>
        <table>
            <tr>
                <th>Aspect</th>
                <th>Implementation</th>
                <th>Effect</th>
            </tr>
            <tr>
                <td>Temperature Control</td>
                <td>Non-linear scaling from 0.1 to 2.0</td>
                <td>Affects model creativity and randomness</td>
            </tr>
            <tr>
                <td>Prompt Construction</td>
                <td>Embedded in generation instructions</td>
                <td>Guides content style and theme</td>
            </tr>
            <tr>
                <td>Mnemonic Generation</td>
                <td>Tone-aware mnemonic creation</td>
                <td>Balances memorability with style</td>
            </tr>
            <tr>
                <td>Example Sentences</td>
                <td>Tone-specific context generation</td>
                <td>Maintains consistent style</td>
            </tr>
            <tr>
                <td>Storage</td>
                <td>Dual storage (seriousness & tone)</td>
                <td>Preserves tone information</td>
            </tr>
        </table>
    </div>

    <div class="section">
        <h2>6. Error Recovery System</h2>
        <div class="mermaid">
        graph TD
            A[Error Detected] --> B{Error Type?}
            B -->|Network| C[Retry with Backoff]
            B -->|API| D[Try Next Model]
            B -->|Validation| E[Use Fallback Data]
            B -->|Parse| F[Clean and Retry]
            B -->|Unknown| G[Log and Fallback]
            
            C --> H{Max Retries?}
            D --> H
            F --> H
            
            H -->|Yes| I[Use Fallback Data]
            H -->|No| J[Retry Operation]
            
            E --> K[Return Result]
            I --> K
            G --> K
        </div>
    </div>

    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis'
            }
        });
    </script>
</body>
</html> 